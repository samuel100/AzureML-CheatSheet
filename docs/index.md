# Azure ML Cheat Sheet

## Basic Objects

### [Workspace](more/workspace.md)

#### Creating a new Workspace

1. To create a new `Workspace`:
    ```python
    from azureml.core import Workspace
    ws = Workspace.create(
        name='<my-workspace-name>',
        resource_group='<my-resource-group>',
        subscription_id='<azure-subscription-id>',
        location='<azure-region>',                  # e.g. 'eastus2'
        create_resource_group=<True/False>,         # default:True
        sku='basic/enterprise',                     # default:'basic'
        exists_ok=<True/False>,                     # default:False
    )
    ```

    ??? "Supported Azure Regions"
        See list of supported Azure regions [here](https://azure.microsoft.com/global-infrastructure/services/?products=machine-learning-service)

2. Write the workspace Azure Resource Manager (ARM) properties to a config file:

    ```python
    ws.write_config(path='.azureml', file_name='config.json')
    ```

    Workspace ARM properties can be loaded later using `from_config()` method.
    The `path` defaults to '.azureml/' and the `file_name` defaults to
    'config.json'.

#### Instantiate a Workspace

1.  Instantiate a workspace with the explicit Azure Resource Manager (ARM) properties:

    ```python
    from azureml.core import Workspace
    ws = Workspace.get(
        subscription_id='<subscription-id>',
        resource_group='<resource-group>',
        workspace_name='<workspace-name>',
    )
    ```

2. Instantiate a workspace from config file:

    ```python
    from azureml.core import Workspace
    ws = Workspace.from_config(path='.azureml')
    # read your aml credentials from config.json and instantiate
    # Workspace object
    ```

    !!! danger "`from_config` search path"
        By default, `from_config()` will search for a file named `config.json` in
        the current and parent directories and in any directory named `.azureml`
        therein. Otherwise the `path` and `_file_name` need to be provided.

#### Delete a Workspace

To delete an Azure Machine Learning workspace:

```python
ws.delete(
    delete_dependent_resources=False,   # delete all resources associated to the ws
    no_wait=False,                      # whether to wait for the deletion to complete
    )
```

!!! tip "Workspaces"
    Workspaces are a foundational object used throughout AML and are used in the
    constructors of many other classes. In the following examples we frequently
    omit the workspace object instantiation and simply refer to `ws`.

    See the [workspaces](more/workspace.md) page for more ways to instantiate a
    workspace.

### Experiment

An experiment is used as an organizational principle, storing run history and
tracking metrics.

#### Get all experiments within a workspace

```python
from azureml.core import Experiment
experiments = Experiment.list(ws, tags=None)
# return list[Experiment]
```

#### Get or create an experiment

```python
from azureml.core import Experiment
exp = Experiment(ws, '<experiment-name>')
```

If the experiment is not found in the workspace, a new experiment is created.

!!! danger "Experiment names"
    Experiment name must be 3-36 characters, start with a letter or a number, and can only contain letters, numbers, underscores, and dashes.

#### Manage experiments

1. Archive an experiment:

    ```python
    exp.archive()
    ```

2. Reactivate an experiment:

    ```python
    exp.reactivate()
    ```

3. Rename an experiment:

    ```python
    exp = Experiment(ws, name='<exp-name>')
    exp.archive()
    exp.reactivate(new_name='<new-name>')
    ```

#### Get all runs within an experiment

1.  Get a generator of all the runs contained in an experiment:

    ```python
    exp.get_runs()
    # return list[Run]
    ```

2. Get only runs of a certain type or with certain tags:

    ```python
    exp.get_runs(type='hyperdrive', tags={'modifiedBy': 'Master CI'})
    # return list[Run]
    ```

    ??? "Run types"
        Run type (str) indicates how the run was created. Examples include 'hyperdrive'
        or 'azureml.scriptrun', but can be extended with custom types.

3. Get run include child runs:

    ```python
    exp.get_runs(include_children=True)
    # return list[Run]
    ```

#### Tag an experiment

Tags on an experiment are stored in a dictionary with string keys and string values.

1. Tag an experiment:

    ```python
    exp.tag('')
    exp.tag('DeploymentCandidate')
    exp.tag('modifiedBy', 'Master CI')
    exp.tag('modifiedBy', 'release pipeline') # careful, tags are mutable
    ```

    OR:

    ```python
    # add a set of tags by providing Dict[str,str]
    exp.set_tags({'modifiedBy': 'Master CI', 'area': 'nlp'})
    ```


### Run

A run represents a single trial of an experiment.

Runs are used to monitor the asynchronous execution of a trial, log metrics and
store output of the trial, and to analyze results and access artifacts
generated by the trial.

??? note "Run IDs"

    A unique `run_id` is automatically generated for each run.

#### Create a run

There are multiple ways to create a run. For example:

=== "Interactive run"

    Create interactive runs in an interactive scenario e.g. Jupyter notebooks.

    ```python
    from azureml.core import Experiment
    exp = Experiment(ws, "<experiment-name>")  # get or create experiment
    
    run = exp.start_logging()                  # start interactive run
    result = my_function()                     # do some things...
    run.log('result', result)                  # log the results to the run
    run.complete()                             # stop the interactive run
    ```

    ??? "Logging"
        See [Logging](#logging).

=== "From configuration"

    To submit a run asynchronously - either to local compute or to cloud
    compute - define a configuration. See
    "[Running Scripts in AML](#running-scripts-in-aml)" for details.

    ```python
    from azureml.core import Experiment
    from azureml.core import ScriptRunConfig
    
    exp = Experiment(ws, "<experiment-name>")
    config = ScriptRunConfig(...)  # provide code, compute, environments, etc.
    run = exp.submit(config)    
    ```

    ??? "ScriptRunConfig"
        See [Running Scripts in AML](#running-scripts-in-aml).

#### Get list of runs

1. List of runs within an experiment:

    ```python
    from azureml.core import Experiment
    from azureml.core import Run
    exp = Experiment(ws, name='<experiment-name>')
    runs = Run.list(exp)
    # return Generator[Run]
    ```

2. List of runs within a compute target:

    ```python
    from azureml.core import ComputeTarget
    from azureml.core import Run
    target = ComputeTarget(ws, name='<target-name>')
    runs_on_target = Run.list_by_compute(target)
    # return Generator[Run]
    ```

3. Filtered list of runs:

    ```python
    from azureml.core import Run
    type_ = 'hyperdrive'
    tags = {'area': 'nlp'}
    status = 'Completed'

    runs = Run.list(exp, type=type_, tags=tags, status=status)
    # return Generator[Run]
    ```

    ??? "Run types"
        Run type (str) indicates how the run was created. Examples include 'hyperdrive'
        or 'azureml.scriptrun', but can be extended with custom types.


#### Managing runs

1. Get run status:

    ```python
    run.get_status()
    ```

2. Cancel a run:

    ```python
    run.cancel()
    ```

3. Mark run as failed:

    ```python
    run.fail(error_details='userError') # error details can be str
    run.fail(error_details=TypeError)   # or BaseException
    ```

#### Get run details

Get the definition, status information, current log files, and other details of the run.

```python
run.get_details()
# return dict[str, str]
```

Keys: `runId`, `target`, `status`, `startTimeUtc`, `endTimeUtc`, `properties`, `datasets`,
`logfiles`. For more details see the [method signature](https://docs.microsoft.com/python/api/azureml-core/azureml.core.run(class)?view=azure-ml-py#get-details--).

### [Compute Target](more/compute-targets.md)

Compute targets are an AML abstraction around the concept of a compute resource.
This can range from your local machine to a cluster of Azure VMs.

#### Use an existing compute target

```python
from azureml.core import ComputeTarget
compute_target = ComputeTarget(workspace=ws, name="<compute-name>")
```

#### Create a compute target

For example, to create a new cluster of between 0 and 4 "Standard_NC24rs_v3"
VMs:

```python
from azureml.core import ComputeTarget
from azureml.core.compute import AmlCompute
compute_config = AmlCompute.provisioning_configuration(
    vm_size="Standard_NC24rs_v3",
    min_nodes=0,
    max_nodes=4,
)
compute_target = ComputeTarget.create(ws, "<compute-name>", compute_config)
compute_target.wait_for_completion(show_output=True)
```

See the [Compute Targets](more/compute-targets.md) page for more examples.

### [Environment](more/environment.md)

The `Environment` class is used to configure reproducable Python environments
for use throughout AML. These environments are versioned and sharable.

**Creating AML Environments.**

=== "From existing Conda environment"

    Create an AML Environment from an existing local conda environment:

    ```python
    from azureml.core import Environment
    env = Environment.from_existing_conda_environment(
        name="<aml-environment-name>",
        conda_environment_name="<conda_environment_name>",
    )
    ```

    ??? "Conda local environments"
        To see your local Conda environments run
    
        ```bash
        conda env list
        ```
    
        For more information, see
        [Managing environments](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html)
        in the conda user guide.

=== "From Conda `env.yml` file"

    Create an AML Environment from a conda `env.yml` file:

    ```python
    from azureml.core import Environment
    my_env = Environment.from_conda_specification(
        name='<environment-name>',
        file_path='<path-to-env.yml>',   # relative paths are okay
    )
    ```

    ??? "Configure conda environments with `env.yml` files"
        Conda environments can be specified by way of an `env.yml` file, e.g.
    
        ```yml
        name: example
        dependencies:
          - numpy
          - pandas
        ```

        For more information, see
        [Managing environments](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html)
        in the conda user guide.

=== "From pip `requirements.txt` file"

    To create an AML environment from a pip `requirement.txt` file:
    
    ```python
    from azureml.core import Environment
    env = Environment.from_pip_specification(
        name='<environment-name>',
        file_path='<path-to-requirements.txt>',
    )
    ```

    ??? "Configure pip environments with `requirements.txt` files"
        Requirements files are pip's way configuring Python environments. For more
        information, see
        [Requirements file](https://pip.pypa.io/en/latest/user_guide/#requirements-files)
        in the pip user guide.


**Registering AML Environments.**

To register this environment with the workspace

```python
env.register(ws) # can be accessed by any user of the workspace
```

To view all environments registered to a workspace

```python
from azureml.core import Environment
registered_environments = Environment.list(ws)
```

## Working with data in AzureML

### [Datastore](more/datastore.md)

#### Get datastore

1. Each workspace comes with a default datastore.

    ```python
    ds = ws.get_default_datastore()
    ```

2. Any datastore that is registered to workspace can be accessed by name.

    ```python
    from azureml.core import Datastore
    ds = Datastore.get(ws, "<name-of-registered-datastore>")
    ```

#### Register a datastore

1. Register a datastore via a SAS token.

    ```python
    ds = Datastore.register_azure_blob_container(
        workspace=ws,
        datastore_name="<datastore-name>",
        container_name="<container-name>",
        account_name="<account-name>",
        sas_token="<sas-token>",
    )
    ```

For more ways authentication options and for different underlying storage see
the AML documentation on
[Datastores](https://docs.microsoft.com/en-us/python/api/azureml-core/azureml.core.datastore(class)?view=azure-ml-py).

### Dataset

A Dataset is a reference to data in a Datastore or behind public web urls.

#### Create a dataset

```python
from azureml.core import Dataset
dataset = Dataset.Tabular.from_delimited_files(path = [(datastore, 'train-dataset/tabular/iris.csv')])
```

#### Preview a dataset

```python
# preview the first 3 rows of the dataset
dataset.take(3).to_pandas_dataframe()
```


## Running Scripts in AML

To run code in AML you need to:

1. **Configure**: Configuration includes specifying the code to run, the compute
target to run on and the Python environment to run in.
2. **Submit**: Create or reuse an AML Experiment and submit the run.

### ScriptRunConfig

A typical directory may have the following structure:

```bash
source_directory/
    script.py    # entry point to your code
    module1.py   # modules called by script.py     
    ...
```

**ScriptRunConfig: Basic**

```python
from azureml.core import ScriptRunConfig

config = ScriptRunConfig(
    source_directory='<path/to/source_directory>',  # relative paths okay
    script='script.py',
)
```

**ScriptRunConfig:Command line arguments**

`script.py` may be set up to accept command line arguments, e.g.,

```bash
python script.py --argument 42 --another_argument 73
```

In that case we pass the arguments list to `config`:

```python
from azureml.core import ScriptRunConfig

config = ScriptRunConfig(
    source_directory='<path/to/source_directory>',
    script='script.py',
    arguments=[
        'argument', 42,
        'another_argument', 73,
    ],
)
```

**ScriptRunConfig: ComputeTarget**

By default this configuration will run on local compute.

To use AML compute target specify in the `run_config` attribute:

```python
from azureml.core import ComputeTarget
compute_target = ComputeTarget(workspace=ws, name="<compute-name>")
config.run_config.target = target # of type azureml.core.ComputeTarget
```

See [Compute Targets](more/compute-targets.md) for creating and accessing
AML ComputeTargets.

**ScriptRunConfig: Environment**

If your script requires a specific Python environment to run: specify in
the `run_config` attribute:

```python
from azureml.core import Environment
env = Environment(ws, '<environment-name>')
config.run_config.environment = env # of type azureml.core.Environment
```

See [Environment](more/environment.md) for managing AML Environments.

**ScriptRunConfig: Submit**

Submit this configuration to run as part of an Experiment.

```python
from azureml.core import Experiment
exp = Experiment(ws, "<experiment-name>")   # get or create Experiment
run = exp.submit(config)                    # submit config to run in AML
# returns Run object
```

## Logging

### Logging metrics

To log metrics in your running script add the following:

```python
from azureml.core import Run
run = Run.get_context()
run.log("metric-name", metric_value)
```

### Viewing metrics with the Python SDK

Viewing metrics in a run

```python
metrics = run.get_metrics()
# metrics is of type Dict[str, List[float]] mapping mertic names
# to a list of the values for that metric in the given run.

metrics.get("metric-name")
# list of metrics in the order they were recorded
```

To view all recorded values for a given metric `my-metric` in a
given experiment `my-experiment`:

```python
experiments = ws.experiments
# of type Dict[str, Experiment] mapping experiment names the
# corresponding Experiment

exp = experiments['my-experiment']
for run in exp.get_runs():
    metrics = run.get_metrics()
    
    my_metric = metrics.get('my-metric')
    if my_metric:
        print(my_metric)
```